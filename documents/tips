[Build a debug version of bochs]
* Download the sources
* ./configure --help
* ./configure --enable-debugger --enable-disasm
* make
* sudo make install


[Build mkinitrd tools]

gcc -o mkinitrd make_initrd.c


[Check the ELF Format]

objdump -xfh bin/crond


[Debugging tips]

* list the break points
blist

* trace the registers after each command
trace-reg on
trace-reg off

* translate linear address to physical address
page 0xC00ab000

* set a write break point
watch w 0x1d8000

* set a lenear address executive break point
lb 0x1040ea

* delete a break point by break point number
d 1

* next statement, not step in
p

* calculate an expression
? 0x1000+0x10
NOTE: no space between the expression

* disassemble the instruction at give address
u /10

* logging 
edit the bochsrc.bxrc, set the log option to a file

* print infomation
info tss

* Debugging process:
lb 0x104008
c
s
(step into irq_common_stub)
u /20
s
(step into irq_handler)
u /10
vb 0x08:0x1015f9
(step into switch_task)
lb 0x101d23
(print the stack when you got a panic)
print-stack 10
(check the value control registers)
creg
(check the page by the virtual address)
page 0xe007ffff

* Debugging APIC
boot your operating system and press the config button in bochs emulator
9. Log options for individual devices
then
28. [APIC0]
choose
ask
for all the actions



[Debugging with GDB+QEMU]

usage: qemu [options] [disk_image]

Note that if you are using GDB of x86_64 platform, you should change the qemu to qemu-system-x86_64.

* compile with debugging symbols using "-g" option

* put all of the debugging information in a separate file
objcopy --only-keep-debug matrix matrix.sym

* strip your executable of debugging information
objcopy --strip-debug matrix

* start qemu with your floppy image
qemu -s -S -drive file=~/vm/matrix/matrix.img,index=0,if=floppy
* start the gdbserver in your virtual machine
in your virtual machine
Ctrl + Alt + 2
gdbserver tcp::2012
* start gdb in another console
gdb
(gdb) file ~/sources/matrix/bin/matrix
Reading symbols from /home/ted/sources/matrix/bin/matrix...(no debugging symbols found)...done.
(gdb) target remote :2012
Remote debugging using :2012
(gdb) symbol-file ~/sources/matrix/bin/matrix.sym
Reading symbols from /home/ted/sources/matrix/bin/matrix.sym...done.
(gdb) break kmain
Breakpoint 1 at 0x10503c: file main.c, line 40.
(gdb) continue
Continuing.

Breakpoint 1, kmain (addr=can't compute CFA for this frame
) at main.c:40
40	{
(gdb)

